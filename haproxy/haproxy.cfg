global
    log stdout format raw local0
    maxconn 4096
    stats socket /var/run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    timeout tunnel  3600s

# Load the dynamic config generated by the API
# This file is regenerated on each tunnel create/delete
frontend https_front
    bind *:80

    # In production, uncomment the line below and comment the line above:
    # bind *:443 ssl crt /usr/local/etc/haproxy/certs/homevpn.pem
    # http-request redirect scheme https unless { ssl_fc }

    http-request set-var(req.subdomain) req.hdr(host),lower,regsub(\.homevpn\.example\.com$,,)

    use_backend %[var(req.subdomain),map(/usr/local/etc/haproxy/dynamic/subdomains.map,bk_not_found)]

    default_backend bk_not_found

backend bk_not_found
    http-request deny deny_status 404
